<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <title>Tööriista skanner</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let selectedUser = "";
    let selectedMinutes = 10;

    function log(msg, color = "black") {
      const logEl = document.getElementById("log");
      logEl.innerHTML = `<span style="color:${color}">${msg}</span>`;
    }

    window.addEventListener("DOMContentLoaded", () => {
      // Nime valik
      document.getElementById("user").addEventListener("change", e => {
        selectedUser = e.target.value;
      });

      // Minutid
      document.getElementById("minutes").addEventListener("change", e => {
        selectedMinutes = parseInt(e.target.value);
      });

      // Skanner
      const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      scanner.render(async (decodedText) => {
        const toolId = decodedText.trim();
        log(`⏳ Uuendan tööriista ${toolId} (${selectedUser}, ${selectedMinutes} min)...`, "blue");

        try {
          const ref = doc(db, "tools", toolId);
          await updateDoc(ref, {
            total_usage_minutes: selectedMinutes,
            last_user: selectedUser,
            last_used: new Date().toISOString().slice(0, 16).replace("T", " ")
          });
          log(`✅ ${toolId} uuendatud!`, "green");
        } catch (err) {
          log(`❌ Viga: ${err.message}`, "red");
        }
      });
    });
  </script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h2>Tööriista vöötkoodi skaneerimine</h2>
  <label>Kasutaja:
    <select id="user">
      <option value="Kallas">Kallas</option>
      <option value="Madis">Madis</option>
      <option value="Tiiu">Tiiu</option>
    </select>
  </label>
  <br />
  <label>Minutid:
    <input type="number" id="minutes" value="10" min="1" />
  </label>
  <br /><br />
  <div id="reader" style="width: 300px;"></div>
  <p id="log">⏳ Valmis skaneerima...</p>
</body>
</html>
